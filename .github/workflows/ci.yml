name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Lint jobs
  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml

  # Build Bun bindings
  build-bun-bindings:
    name: Build Bun Bindings
    uses: ./.github/workflows/build-bun-bindings.yml

  # Build and test Rust
  rust-build:
    name: Rust Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build all packages
        run: cargo build --all-features --all-targets

      - name: Run tests
        run: cargo test --all-features

      - name: Run doc tests
        run: cargo test --all-features --doc

  # Cross-platform builds
  cross-platform-build:
    name: Cross-platform Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-apple-darwin
          - aarch64-apple-darwin
          - x86_64-pc-windows-gnu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install mingw-w64 for Windows
        if: matrix.target == 'x86_64-pc-windows-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Build for ${{ matrix.target }}
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --all-features --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/
          retention-days: 7

  # Test examples
  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build ipc_chat_example
        run: cargo build --release -p ipc_chat_example

      - name: Build wgpu_example
        run: cargo build --release -p wgpu_example

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo-audit
        run: cargo audit || echo "Security audit completed"

  # Publish to crates.io (on release)
  publish-crates:
    name: Publish to Crates.io
    runs-on: ubuntu-latest
    needs: [lint, rust-build, cross-platform-build, build-bun-bindings]
    if: github.event_name == 'release' && github.event.action == 'created'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish single_instance_app
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} -p single_instance_app

      - name: Publish bindings_uniffi
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} -p bindings_uniffi

      - name: Publish ipc_chat_example
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} -p ipc_chat_example

      - name: Publish wgpu_example
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} -p wgpu_example

  # Publish Bun bindings to GitHub Releases
  publish-bun-bindings:
    name: Publish Bun Bindings to GitHub Releases
    runs-on: ubuntu-latest
    needs: [build-bun-bindings]
    if: github.event_name == 'release' && github.event.action == 'created'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: librust_ipc_bindings-*
          path: bindings/
          merge-multiple: true

      - name: Display downloaded files
        run: ls -la bindings/

      - name: Create release bundle
        run: |
          mkdir -p release-bundle
          # Rename files to have platform-specific names
          cp bindings/librust_ipc_bindings-ubuntu-latest/*.so release-bundle/librust_ipc_bindings-linux.so 2>/dev/null || true
          cp bindings/librust_ipc_bindings-macos-latest/*.dylib release-bundle/librust_ipc_bindings-macos.dylib 2>/dev/null || true
          cp bindings/librust_ipc_bindings-windows-latest/*.dll release-bundle/librust_ipc_bindings-windows.dll 2>/dev/null || true
          ls -la release-bundle/

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: release-bundle/*
          generate_release_notes: true
